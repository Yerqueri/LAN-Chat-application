var fs = require('fs');

function createUserData(name,myIP){
    users = {};
    users['users'] = [];
    users['recentuser'] = name;
    userData = {};

    var dt = new Date();

    userData['userName'] = name;
    userData['numberLogins'] = 1;
    userData['mostRecentIP'] = myIP;
    userData['lastLogin'] = dt.toString();

    users['users'].push(userData);

    return users;
}

function readyUserData(name,myIP) {
        json = createUserData(name,myIP);
        jsonData = JSON.stringify(json);
        fs.writeFile('../UserData.txt',jsonData,function(err){
            console.log('Written New File!!');
        });
}

exports.updateUserData = function updateUserData(name,myIP) {
    var flag = 0;
    fs.exists('../UserData.txt',function(exists){
        if(!exists){
            readyUserData(name,myIP);
        }
        else {
            var dt = new Date();
            fs.readFile('../UserData.txt', function (err, data) {
            // Check is Username is same, then increment logins by 1.
                if (err) throw err;
                jsonData = JSON.parse(data);
                jsonData['recentuser'] = name;
                userArray = jsonData['users'];

                for (var i = 0; i < userArray.length; i++) {
                    if(userArray[i]['userName'] === name){
                        flag = 1;
                        userArray[i]['numberLogins'] = userArray[i]['numberLogins'] + 1;
                        userArray[i]['lastLogin'] = dt.toString();
                        break;
                    }
                }

            // Else append new data.
                if(!flag) {
                    userArray.push( { 'userName' : name, 'numberLogins' : 1, 'mostRecentIP' : myIP, 'lastLogin': dt.toString() });
                }
                jsonData['users'] = userArray;

                fs.writeFile('../UserData.txt',JSON.stringify(jsonData),function(err){
                    if(!err)
                        console.log('Written!!!!');
                });
            });
        }
    })
}
